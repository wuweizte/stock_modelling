---
title: "ARIMA Prediction Of Gold--Appendix A"
author: "Wu Wei"
date: "2017-1-26"
output: html_document
---


## Appendix A

```{r library, echo = FALSE}
rm(list = ls())

suppressMessages(library(forecast))
suppressMessages(library(ggplot2))
suppressMessages(library(rugarch))
```

```{r source file, echo = FALSE}
setwd("d://MyR//stock//")

source("CompareObjectAccuracy.R")
source("CompareObjectXregAccuracy.R")
source("CompareObjectEstimated4layersXregAccuracy.R")

source("CompareObjectNaiveAccuracy.R")
source("CompareObjectZeroDiffAccuracy.R")
source("CompareKDJDEstimatedKDJKXregAccuracy.R")

source("CompareObjectArfimaAccuracy.r")


```


### 1.Analyse for predicting monthly gold price

#### 1.1 Forecast relationship between monthly gold price and other variables

```{r appendix 1.1-1, echo = TRUE}


setwd("d://MyR//stock//")
monthly.original.data <- read.csv("goldmonthly.csv")

monthly.close.price <- as.ts(monthly.original.data[,5])
monthly.kdj.k <- as.ts(monthly.original.data[,7])
monthly.kdj.d <- as.ts(monthly.original.data[,8])
```

The last 20 values are left as the test set. 

```{r appendix 1.1-1(2), echo = TRUE, cache=FALSE, eval=TRUE}

training.monthly.close.price <- head(monthly.close.price, 
                                     length(monthly.close.price) - 20)

training.monthly.kdj.k <- head(monthly.kdj.k, 
                               length(monthly.kdj.k) - 20)

training.monthly.kdj.d <- head(monthly.kdj.d, 
                               length(monthly.kdj.d) - 20)

```



```{r appendix 1.1-2, echo = TRUE, cache=TRUE}

reg.lagged.df <- cbind(as.numeric(training.monthly.kdj.k),
                as.numeric(training.monthly.kdj.d),
                as.numeric(training.monthly.kdj.k - training.monthly.kdj.d),

                ts(c(NA, training.monthly.kdj.k[-length(training.monthly.kdj.k)])),
                ts(c(NA, training.monthly.kdj.d[-length(training.monthly.kdj.d)])),
                ts(c(NA, training.monthly.kdj.k[-length(training.monthly.kdj.k)] -
                             training.monthly.kdj.d[-length(training.monthly.kdj.d)])),

                ts(c(NA, NA, head(training.monthly.kdj.k, length(training.monthly.kdj.k) - 2))),
                ts(c(NA, NA, head(training.monthly.kdj.d, length(training.monthly.kdj.d) - 2))),
                ts(c(NA, NA, head(training.monthly.kdj.k, length(training.monthly.kdj.k) - 2) -
                             head(training.monthly.kdj.d, length(training.monthly.kdj.d) - 2))),

                ts(c(NA, NA, NA, head(training.monthly.kdj.k, length(training.monthly.kdj.k) - 3))),
                ts(c(NA, NA, NA, head(training.monthly.kdj.d, length(training.monthly.kdj.d) - 3))),
                ts(c(NA, NA, NA, head(training.monthly.kdj.k, length(training.monthly.kdj.k) - 3) -
                             head(training.monthly.kdj.d, length(training.monthly.kdj.d) - 3))))
```

```{r appendix 1.1-3, echo = TRUE, cache=TRUE}
fit.pure.arima <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                             stepwise = FALSE,
                              approximation = FALSE, max.order = 9)
```

```{r appendix 1.1-4, echo = TRUE, cache=TRUE}

fit.2 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), 2],
                    max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.2.5 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(2,5)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.2.5.8 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(2,5,8)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.2.5.8.11 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(2,5,8,11)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)
```

```{r appendix 1.1-5, echo = TRUE, cache=TRUE}
fit.1 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), 1],
                    max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.1.4 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(1,4)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.1.4.7 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(1,4,7)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.1.4.7.10 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(1,4,7,10)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)
```

```{r appendix 1.1-6, echo = TRUE, cache=TRUE}
fit.3 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), 3],
                    max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.3.6 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(3,6)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.3.6.9 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(3,6,9)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.3.6.9.12 <- auto.arima(training.monthly.close.price[4:length(training.monthly.close.price)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(3,6,9,12)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

```

```{r appendix 1.1-7, echo = FALSE, cache=FALSE}

aicc.name <- c("fit.pure.arima$aicc",
               "fit.2$aicc",
               "fit.2.5$aicc",
               "fit.2.5.8$aicc",
               "fit.2.5.8.11$aicc",
               "fit.1$aicc",
               "fit.1.4$aicc",
               "fit.1.4.7$aicc",
               "fit.1.4.7.10$aicc",
               "fit.3$aicc",
               "fit.3.6$aicc",
               "fit.3.6.9$aicc",
               "fit.3.6.9.12$aicc")

aicc.value <- c(fit.pure.arima$aicc,
                fit.2$aicc,
                fit.2.5$aicc,
                fit.2.5.8$aicc,
                fit.2.5.8.11$aicc,
                fit.1$aicc,
                fit.1.4$aicc,
                fit.1.4.7$aicc,
                fit.1.4.7.10$aicc,
                fit.3$aicc,
                fit.3.6$aicc,
                fit.3.6.9$aicc,
                fit.3.6.9.12$aicc)

aicc.df <- data.frame(name = aicc.name, aicc = aicc.value)

cat("Forecast relationship between monthly gold price and other variables:\n")
print(aicc.df[order(aicc.df$aicc),])

```


It seems that monthly KDJ.K is the best predictor for monthly Close Price. KDJ.D is worse than KDJ.K.
However, to predict  monthly Close Price, forecast values of predictor have to be used.
So self forecast accuracy of predictor should be taken into account.

#### 1.2 Self forecast accuracy of monthly KDJ variables

```{r appendix 1.2-1, echo = FALSE}


setwd("d://MyR//stock//")
monthly.original.data <- read.csv("goldmonthly.csv")

monthly.kdj.k <- as.ts(monthly.original.data[,7])
monthly.kdj.d <- as.ts(monthly.original.data[,8])
```

```{r appendix 1.2-2, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
source("CompareObjectAccuracy.R")

## compare the prediction accuracy of kdj.k, kdj.d and the difference between them

comparison.period <- 20

forecast.period <- 5

training.set.endpoint <- length(monthly.kdj.k) - comparison.period - forecast.period

maxorder <- 9
```

```{r appendix 1.2-3, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.kdj.k <- CompareObjectAccuracy(arg.object = monthly.kdj.k,
                                      arg.forecast.period = forecast.period,
                                      arg.training.set.endpoint = training.set.endpoint,
                                      arg.comparison.period = comparison.period,
                                      arg.maxorder = maxorder)
```

```{r appendix 1.2-4, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.kdj.d <- CompareObjectAccuracy(arg.object = monthly.kdj.d,
                                      arg.forecast.period = forecast.period,
                                      arg.training.set.endpoint = training.set.endpoint,
                                      arg.comparison.period = comparison.period,
                                      arg.maxorder = maxorder)
```

```{r appendix 1.2-5, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.kdj.kd.diff <- CompareObjectAccuracy(arg.object = monthly.kdj.k - monthly.kdj.d ,
                                            arg.forecast.period = forecast.period,
                                            arg.training.set.endpoint = training.set.endpoint,
                                            arg.comparison.period = comparison.period,
                                            arg.maxorder = maxorder)
```

```{r appendix 1.2-6, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
final.result <- cbind(result.kdj.k, result.kdj.d, result.kdj.kd.diff)

final.result <- final.result[, -c(8, 15)]

colnames(final.result) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                            "p2","d2","q2", "dr2","RMSE2", "p.v2",
                            "p3","d3","q3", "dr3","RMSE3", "p.v3")


print(final.result)
```


```{r appendix 1.2-7, fig.height=5, fig.width=7, echo = FALSE, cache=TRUE, eval=TRUE}
name.accuracy <- c("self forecast accuracy of KDJ.K",
                   "self forecast accuracy of KDJ.D",
                   "self forecast accuracy of KDJ.K - KDJ.D")

average.accuracy <- c(mean(final.result$RMSE),
                    mean(final.result$RMSE2),
                    mean(final.result$RMSE3))

max.value <- c(max(monthly.kdj.k),
               max(monthly.kdj.d),
               max(abs(monthly.kdj.k - monthly.kdj.d)))

df.accuracy <- data.frame(name = name.accuracy,
                            average.accuracy = average.accuracy,
                            max.value = max.value)

print(df.accuracy)

ggplot(,aes(x=factor(c(rep("KDJ.K", length(final.result$RMSE)),
                      rep("KDJ.D", length(final.result$RMSE2)),
                      rep("KDJ.KD.difference", length(final.result$RMSE3))),
                     levels = c("KDJ.K", "KDJ.D", "KDJ.KD.difference")),
           y=c(final.result$RMSE, final.result$RMSE2, final.result$RMSE3))) +
        geom_boxplot() +
        xlab("") +
        ylab("RMSE")



```


#### 1.3 Comparison of forecast accuracy of monthly gold price by monthly KDJ.K
```{r appendix 1.3-1, echo = FALSE}


setwd("d://MyR//stock//")
monthly.original.data <- read.csv("goldmonthly.csv")

monthly.close.price <- as.ts(monthly.original.data[,5])
monthly.kdj.k <- as.ts(monthly.original.data[,7])
monthly.kdj.d <- as.ts(monthly.original.data[,8])
```

```{r appendix 1.3-2, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
source("CompareObjectAccuracy.R")
source("CompareObjectXregAccuracy.R")
source("CompareObjectEstimated2layersXregAccuracy.R")


comparison.period <- 20

forecast.period <- 5

training.set.endpoint <- length(monthly.close.price) - comparison.period - forecast.period

maxorder <- 9
```

```{r appendix 1.3-3, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.pure.close.price <- CompareObjectAccuracy(arg.object = monthly.close.price,
                                                 arg.forecast.period = forecast.period,
                                                 arg.training.set.endpoint = training.set.endpoint,
                                                 arg.comparison.period = comparison.period,
                                                 arg.maxorder = maxorder)
```

```{r appendix 1.3-3(2), fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.pure.close.price.maxorder5 <- CompareObjectAccuracy(arg.object = monthly.close.price,
                                                 arg.forecast.period = forecast.period,
                                                 arg.training.set.endpoint = training.set.endpoint,
                                                 arg.comparison.period = comparison.period,
                                                 arg.maxorder = 5)
```

```{r appendix 1.3-3(3), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.pure.close.price.maxorder5$RMSE - result.pure.close.price$RMSE)

t.test(result.pure.close.price.maxorder5$RMSE - result.pure.close.price$RMSE)

sum(result.pure.close.price$p.v >= 0.05)

sum(result.pure.close.price.maxorder5$p.v >= 0.05)

```

```{r appendix 1.3-3(4), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.pure.close.price.maxorder5$RMSE)

summary(result.pure.close.price$RMSE)

t.test(result.pure.close.price.maxorder5$RMSE, result.pure.close.price$RMSE)

```


For predicting monthly gold price using pure Arima model, the difference between the effect of setting max.order to 9 and that of setting max.order to 5 is not signifcant.

```{r appendix 1.3-4, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
reg.lagged.df <- data.frame(cbind(monthly.kdj.k,
                                  ts(c(NA, monthly.kdj.k[-length(monthly.kdj.k)]))))

result.actual.xreg.close.price <-
        CompareObjectXregAccuracy(arg.object = monthly.close.price,
                                  arg.forecast.period = forecast.period,
                                  arg.training.set.endpoint = training.set.endpoint,
                                  arg.comparison.period = comparison.period,
                                  arg.maxorder = maxorder,
                                  arg.xreg = reg.lagged.df)
```

```{r appendix 1.3-5, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.2layers.xreg.close.price <-
        CompareObjectEstimated2layersXregAccuracy(arg.object = monthly.close.price,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = maxorder,
                                                  arg.reg.variable = monthly.kdj.k)
```

```{r appendix 1.3-5(2), fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.2layers.xreg.close.price.maxorder5 <-
        CompareObjectEstimated2layersXregAccuracy(arg.object = monthly.close.price,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = 5,
                                                  arg.reg.variable = monthly.kdj.k)
```

```{r appendix 1.3-5(3), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.predicted.2layers.xreg.close.price.maxorder5$RMSE - 
                result.predicted.2layers.xreg.close.price$RMSE)

t.test(result.predicted.2layers.xreg.close.price.maxorder5$RMSE - 
               result.predicted.2layers.xreg.close.price$RMSE)

sum(result.predicted.2layers.xreg.close.price$p.v >= 0.05)

sum(result.predicted.2layers.xreg.close.price.maxorder5$p.v >= 0.05)

```

```{r appendix 1.3-5(4), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.predicted.2layers.xreg.close.price.maxorder5$RMSE)

summary(result.predicted.2layers.xreg.close.price$RMSE)

t.test(result.predicted.2layers.xreg.close.price.maxorder5$RMSE,
       result.predicted.2layers.xreg.close.price$RMSE)

```


For predicting monthly gold price using pure Arima model with monthly kdj.k, the difference between the effect of setting max.order to 9 and that of setting max.order to 5 is not signifcant.


```{r appendix 1.3-6, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
final.result.kdj.k <- cbind(result.pure.close.price,
                      result.actual.xreg.close.price,
                      result.predicted.2layers.xreg.close.price)

final.result.kdj.k <- final.result.kdj.k[, -c(8, 15)]

colnames(final.result.kdj.k) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                            "p2","d2","q2", "dr2","RMSE2", "p.v2",
                            "p3","d3","q3", "dr3","RMSE3", "p.v3")


print(final.result.kdj.k)
```

```{r appendix 1.3-7, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
model.name <- c("pure close price Arima",
                   "Arima with actual KDJ.K",
                   "Arima with predicted KDJ.K")

average.rmse <- c(mean(final.result.kdj.k$RMSE),
                    mean(final.result.kdj.k$RMSE2),
                    mean(final.result.kdj.k$RMSE3))

pv.up.0.05 <- c(sum(final.result.kdj.k$p.v >= 0.05),
                sum(final.result.kdj.k$p.v2 >= 0.05),
                sum(final.result.kdj.k$p.v3 >= 0.05))


df.accuracy <- data.frame(model = model.name,
                          average.rmse = average.rmse,
                          pv.up.0.05 = pv.up.0.05)


print(df.accuracy)

mean(final.result.kdj.k$RMSE > final.result.kdj.k$RMSE3)

```


#### 1.4 Comparison of forecast accuracy of monthly gold price by monthly KDJ.D
```{r appendix 1.4-1, echo = FALSE}
# 
# 
# setwd("d://MyR//stock//")
# monthly.original.data <- read.csv("goldmonthly.csv")
# 
# monthly.close.price <- as.ts(monthly.original.data[,5])
# monthly.kdj.d <- as.ts(monthly.original.data[,8])
```

```{r appendix 1.4-2, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
# source("CompareObjectAccuracy.R")
source("CompareObjectXregAccuracy.R")
source("CompareObjectEstimated3layersXregAccuracy.R")


comparison.period <- 20

forecast.period <- 5

training.set.endpoint <- length(monthly.close.price) - comparison.period - forecast.period

maxorder <- 9

# result.pure.close.price <- CompareObjectAccuracy(arg.object = monthly.close.price,
#                                                  arg.forecast.period = forecast.period,
#                                                  arg.training.set.endpoint = training.set.endpoint,
#                                                  arg.comparison.period = comparison.period,
#                                                  arg.maxorder = maxorder)
```

```{r appendix 1.4-3, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
reg.lagged.df <- data.frame(cbind(monthly.kdj.d,
                                  ts(c(NA, monthly.kdj.d[-length(monthly.kdj.d)])),
                                  ts(c(NA, NA, head(monthly.kdj.d, length(monthly.kdj.d) - 2)))))


result.actual.xreg.close.price <-
        CompareObjectXregAccuracy(arg.object = monthly.close.price,
                                  arg.forecast.period = forecast.period,
                                  arg.training.set.endpoint = training.set.endpoint,
                                  arg.comparison.period = comparison.period,
                                  arg.maxorder = maxorder,
                                  arg.xreg = reg.lagged.df)
```

```{r appendix 1.4-4, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.3layers.xreg.close.price <-
        CompareObjectEstimated3layersXregAccuracy(arg.object = monthly.close.price,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = maxorder,
                                                  arg.reg.variable = monthly.kdj.d)
```

```{r appendix 1.4-4(2), fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.3layers.xreg.close.price.maxorder5 <-
        CompareObjectEstimated3layersXregAccuracy(arg.object = monthly.close.price,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = 5,
                                                  arg.reg.variable = monthly.kdj.d)
```

```{r appendix 1.4-4(3), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.predicted.3layers.xreg.close.price.maxorder5$RMSE - 
                result.predicted.3layers.xreg.close.price$RMSE)

t.test(result.predicted.3layers.xreg.close.price.maxorder5$RMSE - 
               result.predicted.3layers.xreg.close.price$RMSE)

sum(result.predicted.3layers.xreg.close.price$p.v >= 0.05)

sum(result.predicted.3layers.xreg.close.price.maxorder5$p.v >= 0.05)

```

```{r appendix 1.4-4(4), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.predicted.3layers.xreg.close.price.maxorder5$RMSE)

summary(result.predicted.3layers.xreg.close.price$RMSE)

t.test(result.predicted.3layers.xreg.close.price.maxorder5$RMSE,
               result.predicted.3layers.xreg.close.price$RMSE)

```


For predicting monthly gold price using pure Arima model with monthly kdj.d, the difference between the effect of setting max.order to 9 and that of setting max.order to 5 is not signifcant.


```{r appendix 1.4-5, fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
final.result.kdj.d <- cbind(result.pure.close.price,
                      result.actual.xreg.close.price,
                      result.predicted.3layers.xreg.close.price)

final.result.kdj.d <- final.result.kdj.d[, -c(8, 15)]

colnames(final.result.kdj.d) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                            "p2","d2","q2", "dr2","RMSE2", "p.v2",
                            "p3","d3","q3", "dr3","RMSE3", "p.v3")


print(final.result.kdj.d)
```

```{r appendix 1.4-6, fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
model.name <- c("pure close price Arima",
                   "Arima with actual KDJ.D",
                   "Arima with predicted KDJ.D")

average.rmse <- c(mean(final.result.kdj.d$RMSE),
                    mean(final.result.kdj.d$RMSE2),
                    mean(final.result.kdj.d$RMSE3))

pv.up.0.05 <- c(sum(final.result.kdj.d$p.v >= 0.05),
                sum(final.result.kdj.d$p.v2 >= 0.05),
                sum(final.result.kdj.d$p.v3 >= 0.05))

df.accuracy <- data.frame(model = model.name,
                          average.rmse = average.rmse,
                          pv.up.0.05 = pv.up.0.05)

print(df.accuracy)

mean(final.result.kdj.d$RMSE > final.result.kdj.d$RMSE3)

```

#### 1.5 Comparison of forecast accuracy of monthly gold price by the difference of monthly KDJ.K and monthly KDJ.D
```{r appendix 1.5-1, echo = FALSE}
# rm(list = ls())
# 
# setwd("d://MyR//stock//")
# monthly.original.data <- read.csv("goldmonthly.csv")
# 
# monthly.close.price <- as.ts(monthly.original.data[,5])
# monthly.kdj.k <- as.ts(monthly.original.data[,7])
# monthly.kdj.d <- as.ts(monthly.original.data[,8])
```

```{r appendix 1.5-2, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
# source("CompareObjectAccuracy.R")
source("CompareObjectXregAccuracy.R")
source("CompareObjectEstimated3layersXregAccuracy.R")


comparison.period <- 20

forecast.period <- 5

training.set.endpoint <- length(monthly.close.price) - comparison.period - forecast.period

maxorder <- 9

# result.pure.close.price <- CompareObjectAccuracy(arg.object = monthly.close.price,
#                                                  arg.forecast.period = forecast.period,
#                                                  arg.training.set.endpoint = training.set.endpoint,
#                                                  arg.comparison.period = comparison.period,
#                                                  arg.maxorder = maxorder)

```

```{r appendix 1.5-3, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
monthly.kdj.kd.diff <- monthly.kdj.k - monthly.kdj.d

reg.lagged.df <- data.frame(cbind(monthly.kdj.kd.diff,
                                  ts(c(NA, monthly.kdj.kd.diff[-length(monthly.kdj.kd.diff)])),
                                  ts(c(NA, NA, head(monthly.kdj.kd.diff, length(monthly.kdj.kd.diff) - 2)))))


result.actual.xreg.close.price <-
        CompareObjectXregAccuracy(arg.object = monthly.close.price,
                                  arg.forecast.period = forecast.period,
                                  arg.training.set.endpoint = training.set.endpoint,
                                  arg.comparison.period = comparison.period,
                                  arg.maxorder = maxorder,
                                  arg.xreg = reg.lagged.df)
```

```{r appendix 1.5-4, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.3layers.xreg.close.price <-
        CompareObjectEstimated3layersXregAccuracy(arg.object = monthly.close.price,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = maxorder,
                                                  arg.reg.variable = monthly.kdj.kd.diff)
```

```{r appendix 1.5-4(2), fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.3layers.xreg.close.price.maxorder5 <-
        CompareObjectEstimated3layersXregAccuracy(arg.object = monthly.close.price,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = 5,
                                                  arg.reg.variable = monthly.kdj.kd.diff)
```

```{r appendix 1.5-4(3), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.predicted.3layers.xreg.close.price.maxorder5$RMSE - 
                result.predicted.3layers.xreg.close.price$RMSE)

t.test(result.predicted.3layers.xreg.close.price.maxorder5$RMSE - 
               result.predicted.3layers.xreg.close.price$RMSE)

sum(result.predicted.3layers.xreg.close.price$p.v >= 0.05)

sum(result.predicted.3layers.xreg.close.price.maxorder5$p.v >= 0.05)

```

```{r appendix 1.5-4(4), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.predicted.3layers.xreg.close.price.maxorder5$RMSE)

summary(result.predicted.3layers.xreg.close.price$RMSE)

t.test(result.predicted.3layers.xreg.close.price.maxorder5$RMSE, 
               result.predicted.3layers.xreg.close.price$RMSE)

```
For predicting monthly gold price using pure Arima model with monthly kdj.kd.diff, the difference between the effect of setting max.order to 9 and that of setting max.order to 5 is not signifcant.


```{r appendix 1.5-5, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
final.result.kdj.kd.diff <- cbind(result.pure.close.price,
                      result.actual.xreg.close.price,
                      result.predicted.3layers.xreg.close.price)

final.result.kdj.kd.diff <- final.result.kdj.kd.diff[, -c(8, 15)]

colnames(final.result.kdj.kd.diff) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                            "p2","d2","q2", "dr2","RMSE2", "p.v2",
                            "p3","d3","q3", "dr3","RMSE3", "p.v3")


print(final.result.kdj.kd.diff)
```

```{r appendix 1.5-6, fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
model.name <- c("pure close price Arima",
                   "Arima with actual KDJ.KD.diff",
                   "Arima with predicted KDJ.KD.diff")

average.rmse <- c(mean(final.result.kdj.kd.diff$RMSE),
                    mean(final.result.kdj.kd.diff$RMSE2),
                    mean(final.result.kdj.kd.diff$RMSE3))


pv.up.0.05 <- c(sum(final.result.kdj.kd.diff$p.v >= 0.05),
                sum(final.result.kdj.kd.diff$p.v2 >= 0.05),
                sum(final.result.kdj.kd.diff$p.v3 >= 0.05))

df.accuracy <- data.frame(model = model.name,
                          average.rmse = average.rmse,
                          pv.up.0.05 = pv.up.0.05)

print(df.accuracy)

mean(final.result.kdj.kd.diff$RMSE > final.result.kdj.kd.diff$RMSE3)


```

#### 1.6 Comparison of forecast accuracy of monthly gold price by different factors using predicted value

```{r appendix 1.6, fig.height=5, fig.width=7, echo = TRUE, cache=FALSE, eval=TRUE}

ggplot(,aes(x=factor(c(rep("Pure Arima", length(final.result.kdj.k$RMSE)),
                       rep("KDJ.K", length(final.result.kdj.k$RMSE3)),
                      rep("KDJ.D", length(final.result.kdj.d$RMSE3)),
                      rep("KDJ.KD.difference", length(final.result.kdj.kd.diff$RMSE3))),
                     levels = c("Pure Arima", 
                                "KDJ.K", 
                                "KDJ.D", 
                                "KDJ.KD.difference")),
           y=c(final.result.kdj.k$RMSE, 
               final.result.kdj.k$RMSE3, 
               final.result.kdj.d$RMSE3, 
               final.result.kdj.kd.diff$RMSE3))) +
        geom_boxplot() +
        xlab("") +
        ylab("RMSE")

ggplot(,aes(x=factor(c(rep("Pure Arima - KDJ.K", length(final.result.kdj.k$RMSE3)),
                      rep("Pure Arima - KDJ.D", length(final.result.kdj.d$RMSE3)),
                      rep("Pure Arima - KDJ.KD.difference", length(final.result.kdj.kd.diff$RMSE3))),
                     levels = c("Pure Arima - KDJ.K", 
                                "Pure Arima - KDJ.D", 
                                "Pure Arima - KDJ.KD.difference")),
           y=c(final.result.kdj.k$RMSE - final.result.kdj.k$RMSE3, 
               final.result.kdj.k$RMSE - final.result.kdj.d$RMSE3, 
               final.result.kdj.k$RMSE - final.result.kdj.kd.diff$RMSE3))) +
        geom_boxplot() +
        xlab("") +
        ylab("RMSE difference")

t.test(final.result.kdj.k$RMSE - final.result.kdj.k$RMSE3)
t.test(final.result.kdj.k$RMSE - final.result.kdj.d$RMSE3)
t.test(final.result.kdj.k$RMSE - final.result.kdj.kd.diff$RMSE3)

t.test(final.result.kdj.k$RMSE, final.result.kdj.k$RMSE3)
t.test(final.result.kdj.k$RMSE, final.result.kdj.d$RMSE3)
t.test(final.result.kdj.k$RMSE, final.result.kdj.kd.diff$RMSE3)

```

0 is included in the 95% prediction interval of the 3 t test results.  So the effect of using other predictor is the same with that of using pure Arima model.

It can be concluded that pure Arima model with max.order set to 5 is well for predicting monthly gold  price.

#### 1.7 Comparison of pure Arima model of monthly gold price with naive model

```{r appendix 1.7, fig.height=5, fig.width=7, echo = TRUE, cache=FALSE, eval=TRUE}
setwd("d://MyR//stock//")
source("CompareObjectNaiveAccuracy.R")
source("CompareObjectArimaNaiveAccuracy.R")
```

```{r appendix 1.7(2), fig.height=5, fig.width=7, echo = TRUE, cache=TRUE, eval=TRUE}
result.naive.close.price <- CompareObjectNaiveAccuracy(arg.object = monthly.close.price,
                                                 arg.forecast.period = forecast.period,
                                                 arg.training.set.endpoint = training.set.endpoint,
                                                 arg.comparison.period = comparison.period,
                                                 arg.maxorder = maxorder)
```

```{r appendix 1.7(3), fig.height=5, fig.width=7, echo = TRUE, cache=TRUE, eval=TRUE}
result.arima.naive.close.price <- CompareObjectArimaNaiveAccuracy(arg.object = monthly.close.price,
                                                 arg.forecast.period = forecast.period,
                                                 arg.training.set.endpoint = training.set.endpoint,
                                                 arg.comparison.period = comparison.period,
                                                 arg.maxorder = 5)
```


```{r appendix 1.7(4), fig.height=5, fig.width=7, echo = TRUE, cache=FALSE, eval=TRUE}
t.test(result.pure.close.price.maxorder5$RMSE - result.naive.close.price$RMSE)

t.test(result.pure.close.price.maxorder5$RMSE, result.naive.close.price$RMSE)

summary(result.pure.close.price.maxorder5$RMSE)

summary(result.naive.close.price$RMSE)

summary(result.arima.naive.close.price$RMSE)

# t.test(result.pure.close.price$RMSE - result.naive.close.price$RMSE)

final.result.close.price <- cbind(result.pure.close.price.maxorder5,
                      result.naive.close.price,
                      result.arima.naive.close.price)

# final.result.close.price <- cbind(result.pure.close.price.maxorder5,
#                       result.naive.close.price)

final.result.close.price <- final.result.close.price[, -c(8,15)]

colnames(final.result.close.price) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                            "p2","d2","q2", "dr2","RMSE2", "p.v2",
                            "p3","d3","q3", "dr3","RMSE3", "p.v3")

# final.result.close.price <- final.result.close.price[, -c(8)]

# colnames(final.result.close.price) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
#                             "p2","d2","q2", "dr2","RMSE2", "p.v2")

print(final.result.close.price)

sum(final.result.close.price$RMSE > final.result.close.price$RMSE2)

sum(final.result.close.price$p.v > 0.05)
sum(final.result.close.price$p.v2 > 0.05)

```

It can be concluded that hybrid model with Arima model and naive model is well for predicting monthly gold price.

#### 1.8 Comparison of pure Arima model of monthly gold price with Zero Difference model

```{r appendix 1.8, fig.height=5, fig.width=7, echo = TRUE, cache=TRUE, eval=TRUE}
setwd("d://MyR//stock//")
source("CompareObjectZeroDiffAccuracy.R")

training.set.endpoint <- length(monthly.close.price) - 50 - forecast.period

result.zero.diff.close.price.50 <- 
        CompareObjectZeroDiffAccuracy(arg.object = monthly.close.price,
                                      arg.forecast.period = forecast.period,
                                      arg.training.set.endpoint = training.set.endpoint,
                                      arg.comparison.period = 50,
                                      arg.maxorder = maxorder)
```


```{r appendix 1.8(1), fig.height=5, fig.width=7, echo = TRUE, cache=TRUE, eval=TRUE}
result.pure.close.price.50 <- 
        CompareObjectAccuracy(arg.object = monthly.close.price,
                              arg.forecast.period = forecast.period,
                              arg.training.set.endpoint = training.set.endpoint,
                              arg.comparison.period = 50,
                              arg.maxorder = maxorder)


```

```{r appendix 1.8(2), fig.height=5, fig.width=7, echo = TRUE, cache=FALSE, eval=TRUE}

t.test(result.pure.close.price.50$RMSE - result.zero.diff.close.price.50$RMSE)


summary(result.pure.close.price.50$RMSE)

summary(result.zero.diff.close.price.50$RMSE)

final.result.close.price <- cbind(result.pure.close.price.50, result.zero.diff.close.price.50)

final.result.close.price <- final.result.close.price[, -c(8)]

colnames(final.result.close.price) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                            "p2","d2","q2", "dr2","RMSE2", "p.v2")

print(final.result.close.price)

sum(final.result.close.price$RMSE > final.result.close.price$RMSE2)

sum(final.result.close.price$p.v >= 0.05)

sum(final.result.close.price$p.v2 >= 0.05)

```




### 3.Analyse for predicting monthly KDJ.K

#### 3.1 Forecast relationship between monthly KDJ.K and other variables
```{r appendix 3.1-1, echo = FALSE, cache=TRUE}
rm(list = ls())

setwd("d://MyR//stock//")
monthly.original.data <- read.csv("goldmonthly.csv")

monthly.close.price <- as.ts(monthly.original.data[,5])
monthly.kdj.k <- as.ts(monthly.original.data[,7])
monthly.kdj.d <- as.ts(monthly.original.data[,8])
```

The last 20 values are left as the test set. 

```{r appendix 3.1-1(2), echo = TRUE, cache=FALSE, eval=TRUE}

training.monthly.close.price <- head(monthly.close.price, 
                                     length(monthly.close.price) - 20)

training.monthly.kdj.k <- head(monthly.kdj.k, 
                               length(monthly.kdj.k) - 20)

training.monthly.kdj.d <- head(monthly.kdj.d, 
                               length(monthly.kdj.d) - 20)

```


```{r appendix 3.1-2, echo = TRUE, cache=FALSE, eval=TRUE}

reg.lagged.df <- cbind(as.numeric(training.monthly.kdj.d),
                as.numeric(training.monthly.kdj.k - training.monthly.kdj.d),
                as.numeric(training.monthly.close.price),

                ts(c(NA, training.monthly.kdj.d[-length(training.monthly.kdj.d)])),
                ts(c(NA, training.monthly.kdj.k[-length(training.monthly.kdj.k)] -
                             training.monthly.kdj.d[-length(training.monthly.kdj.d)])),
                ts(c(NA, training.monthly.close.price[-length(training.monthly.close.price)])),
                
                
                ts(c(NA, NA, head(training.monthly.kdj.d, length(training.monthly.kdj.d) - 2))),
                ts(c(NA, NA, head(training.monthly.kdj.k, length(training.monthly.kdj.k) - 2) -
                             head(training.monthly.kdj.d, length(training.monthly.kdj.d) - 2))),
                ts(c(NA, NA, head(training.monthly.close.price, length(training.monthly.close.price) - 2))),
                
                ts(c(NA, NA, NA, head(training.monthly.kdj.d, length(training.monthly.kdj.d) - 3))),
                ts(c(NA, NA, NA, head(training.monthly.kdj.k, length(training.monthly.kdj.k) - 3) -
                             head(training.monthly.kdj.d, length(training.monthly.kdj.d) - 3))),
                ts(c(NA, NA, NA, head(training.monthly.close.price, length(training.monthly.close.price) - 3))))
```

```{r appendix 3.1-3, echo = TRUE, cache=TRUE, eval=TRUE}
fit.pure.arima <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                             stepwise = FALSE,
                              approximation = FALSE, max.order = 9)
```

```{r appendix 3.1-4, echo = TRUE, cache=TRUE, eval=TRUE}
fit.2 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), 2],
                    max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.2.5 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(2,5)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.2.5.8 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(2,5,8)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.2.5.8.11 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(2,5,8,11)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)
```

```{r appendix 3.1-5, echo = TRUE, cache=TRUE, eval=TRUE}
fit.1 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), 1],
                    max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.1.4 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(1,4)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.1.4.7 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(1,4,7)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.1.4.7.10 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(1,4,7,10)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)
```

```{r appendix 3.1-6, echo = TRUE, cache=TRUE, eval=TRUE}
fit.3 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), 3],
                    max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.3.6 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(3,6)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.3.6.9 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(3,6,9)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

fit.3.6.9.12 <- auto.arima(training.monthly.kdj.k[4:length(training.monthly.kdj.k)],
                     xreg = reg.lagged.df[4:nrow(reg.lagged.df), c(3,6,9,12)],
                     max.order = 9, stepwise = FALSE, approximation = FALSE)

```

```{r appendix 3.1-7, echo = FALSE, cache=FALSE, eval=TRUE}

aicc.name <- c("fit.pure.arima$aicc",
               "fit.2$aicc",
               "fit.2.5$aicc",
               "fit.2.5.8$aicc",
               "fit.2.5.8.11$aicc",
               "fit.1$aicc",
               "fit.1.4$aicc",
               "fit.1.4.7$aicc",
               "fit.1.4.7.10$aicc",
               "fit.3$aicc",
               "fit.3.6$aicc",
               "fit.3.6.9$aicc",
               "fit.3.6.9.12$aicc")

aicc.value <- c(fit.pure.arima$aicc,
                fit.2$aicc,
                fit.2.5$aicc,
                fit.2.5.8$aicc,
                fit.2.5.8.11$aicc,
                fit.1$aicc,
                fit.1.4$aicc,
                fit.1.4.7$aicc,
                fit.1.4.7.10$aicc,
                fit.3$aicc,
                fit.3.6$aicc,
                fit.3.6.9$aicc,
                fit.3.6.9.12$aicc)

aicc.df <- data.frame(name = aicc.name, aicc = aicc.value)

cat("Forecast relationship between monthly KDJ.K and other variables:\n")
print(aicc.df[order(aicc.df$aicc),])

```

#### 3.2 Comparison of forecast accuracy of monthly KDJ.K by monthly KDJ.D
```{r appendix 3.2-1, echo = FALSE}
rm(list = ls())

setwd("d://MyR//stock//")
monthly.original.data <- read.csv("goldmonthly.csv")

monthly.close.price <- as.ts(monthly.original.data[,5])
monthly.kdj.k <- as.ts(monthly.original.data[,7])
monthly.kdj.d <- as.ts(monthly.original.data[,8])
```

```{r appendix 3.2-2, fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
source("CompareObjectAccuracy.R")
source("CompareObjectXregAccuracy.R")
source("CompareObjectEstimated2layersXregAccuracy.R")


comparison.period <- 20

forecast.period <- 5

training.set.endpoint <- length(monthly.kdj.k) - comparison.period - forecast.period

maxorder <- 5
```

```{r appendix 3.2-3, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.pure.kdj.k <- CompareObjectAccuracy(arg.object = monthly.kdj.k,
                                                 arg.forecast.period = forecast.period,
                                                 arg.training.set.endpoint = training.set.endpoint,
                                                 arg.comparison.period = comparison.period,
                                                 arg.maxorder = maxorder)

```

```{r appendix 3.2-3(2), fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.pure.kdj.k.maxorder9 <- CompareObjectAccuracy(arg.object = monthly.kdj.k,
                                                 arg.forecast.period = forecast.period,
                                                 arg.training.set.endpoint = training.set.endpoint,
                                                 arg.comparison.period = comparison.period,
                                                 arg.maxorder = 9)

```


```{r appendix 3.2-3(3), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.pure.kdj.k.maxorder9$RMSE - result.pure.kdj.k$RMSE)

sum(result.pure.kdj.k$p.v >= 0.05)

sum(result.pure.kdj.k.maxorder9$p.v >= 0.05)

```


For predicting kdj.k using pure Arima model, the effect of setting max.order to 9 is the same with that of setting max.order to 5.


```{r appendix 3.2-4, fig.height=12, fig.width=10, echo = FALSE, cache=TRUE, eval=TRUE}

reg.lagged.df <- data.frame(cbind(monthly.kdj.d,
                                  ts(c(NA, monthly.kdj.d[-length(monthly.kdj.d)]))))

result.actual.xreg.kdj.k <-
        CompareObjectXregAccuracy(arg.object = monthly.kdj.k,
                                  arg.forecast.period = forecast.period,
                                  arg.training.set.endpoint = training.set.endpoint,
                                  arg.comparison.period = comparison.period,
                                  arg.maxorder = maxorder,
                                  arg.xreg = reg.lagged.df)
```


```{r appendix 3.2-5, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}

result.predicted.2layers.xreg.kdj.k <-
        CompareObjectEstimated2layersXregAccuracy(arg.object = monthly.kdj.k,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = maxorder,
                                                  arg.reg.variable = monthly.kdj.d)
```

```{r appendix 3.2-5(2), fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}

result.predicted.2layers.xreg.kdj.k.maxorder9 <-
        CompareObjectEstimated2layersXregAccuracy(arg.object = monthly.kdj.k,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = 9,
                                                  arg.reg.variable = monthly.kdj.d)
```

```{r appendix 3.2-5(3), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.predicted.2layers.xreg.kdj.k.maxorder9$RMSE - result.predicted.2layers.xreg.kdj.k$RMSE)

t.test(result.predicted.2layers.xreg.kdj.k.maxorder9$RMSE - result.predicted.2layers.xreg.kdj.k$RMSE,
       conf.level = 0.95)

sum(result.predicted.2layers.xreg.kdj.k.maxorder9$p.v >= 0.05)

sum(result.predicted.2layers.xreg.kdj.k$p.v >= 0.05)

```

For predicting kdj.k using dynamic Arima model with estimated kdj.d, the difference between the effect of setting max.order to 9 and that of setting max.order to 5 is not significant.

```{r appendix 3.2-6, fig.height=12, fig.width=10, echo = FALSE, cache=FALSE, eval=TRUE}
final.result.kdj.d <- cbind(result.pure.kdj.k,
                      result.actual.xreg.kdj.k,
                      result.predicted.2layers.xreg.kdj.k)

final.result.kdj.d <- final.result.kdj.d[, -c(8, 15)]

colnames(final.result.kdj.d) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                            "p2","d2","q2", "dr2","RMSE2", "p.v2",
                            "p3","d3","q3", "dr3","RMSE3", "p.v3")


print(final.result.kdj.d)
```

```{r appendix 3.2-7, fig.height=12, fig.width=10, echo = FALSE, cache=FALSE, eval=TRUE}
model.name <- c("Accuracy of pure kdj.k Arima",
                   "Accuracy of Arima with actual KDJ.D",
                   "Accuracy of Arima with predicted KDJ.D")

average.rmse <- c(mean(final.result.kdj.d$RMSE),
                    mean(final.result.kdj.d$RMSE2),
                    mean(final.result.kdj.d$RMSE3))

pv.up.0.05 <- c(sum(final.result.kdj.d$p.v >= 0.05),
                sum(final.result.kdj.d$p.v2 >= 0.05),
                sum(final.result.kdj.d$p.v3 >= 0.05))


df.accuracy <- data.frame(model = model.name,
                          average.rmse = average.rmse,
                          pv.up.0.05 = pv.up.0.05)

print(df.accuracy)

mean(final.result.kdj.d$RMSE > final.result.kdj.d$RMSE3)


```

For predicting kdj.k using dynamic Arima model with estimated kdj.d, some chosen ARIMA models is (0,0,0), which means that there is only linear relationship between kdj.k and estimated kdj.d. 


#### 3.3 Comparison of forecast accuracy of monthly KDJ.K by difference of monthly KDJ.K and monthly KDJ.D
```{r appendix 3.3-1, echo = FALSE}
# rm(list = ls())
# 
# setwd("d://MyR//stock//")
# monthly.original.data <- read.csv("goldmonthly.csv")
# 
# monthly.close.price <- as.ts(monthly.original.data[,5])
# monthly.kdj.k <- as.ts(monthly.original.data[,7])
# monthly.kdj.d <- as.ts(monthly.original.data[,8])
```

```{r appendix 3.3-2, fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
source("CompareObjectAccuracy.R")
source("CompareObjectXregAccuracy.R")
source("CompareObjectEstimated4layersXregAccuracy.R")


comparison.period <- 20

forecast.period <- 5

training.set.endpoint <- length(monthly.kdj.k) - comparison.period - forecast.period

maxorder <- 5

# result.pure.kdj.k <- CompareObjectAccuracy(arg.object = monthly.kdj.k,
#                                                  arg.forecast.period = forecast.period,
#                                                  arg.training.set.endpoint = training.set.endpoint,
#                                                  arg.comparison.period = comparison.period,
#                                                  arg.maxorder = maxorder)


monthly.kdj.kd.diff <- monthly.kdj.k - monthly.kdj.d
reg.lagged.df <- 
        data.frame(cbind(monthly.kdj.kd.diff,
                         ts(c(NA, monthly.kdj.kd.diff[-length(monthly.kdj.kd.diff)])),
                         ts(c(NA, NA, head(monthly.kdj.kd.diff, length(monthly.kdj.kd.diff) - 2))),
                         ts(c(NA, NA, NA, head(monthly.kdj.kd.diff, length(monthly.kdj.kd.diff) - 3)))))
```

```{r appendix 3.3-3, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.actual.xreg.kdj.k <-
        CompareObjectXregAccuracy(arg.object = monthly.kdj.k,
                                  arg.forecast.period = forecast.period,
                                  arg.training.set.endpoint = training.set.endpoint,
                                  arg.comparison.period = comparison.period,
                                  arg.maxorder = maxorder,
                                  arg.xreg = reg.lagged.df)

```

```{r appendix 3.3-4, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.4layers.xreg.kdj.k <-
        CompareObjectEstimated4layersXregAccuracy(arg.object = monthly.kdj.k,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = maxorder,
                                                  arg.reg.variable = monthly.kdj.kd.diff)

```

```{r appendix 3.3-4(2), fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.4layers.xreg.kdj.k.maxorder9 <-
        CompareObjectEstimated4layersXregAccuracy(arg.object = monthly.kdj.k,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = 9,
                                                  arg.reg.variable = monthly.kdj.kd.diff)

```

```{r appendix 3.3-4(3), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.predicted.4layers.xreg.kdj.k.maxorder9$RMSE - result.predicted.4layers.xreg.kdj.k$RMSE)

t.test(result.predicted.4layers.xreg.kdj.k.maxorder9$RMSE - result.predicted.4layers.xreg.kdj.k$RMSE)

sum(result.predicted.4layers.xreg.kdj.k.maxorder9$p.v >= 0.05)

sum(result.predicted.4layers.xreg.kdj.k$p.v >= 0.05)

```

For predicting kdj.k using dynamic Arima model with estimated kdj.kd.diff, the difference between the effect of setting max.order to 9 and that of setting max.order to 5 is not significant. 
P value of both models is less than 5% in most situations, which seems that Arima model with estimated kdj.kd.diff is not a good way.


```{r appendix 3.3-5, fig.height=12, fig.width=10, echo = FALSE, cache=FALSE, eval=TRUE}

final.result.kdj.kd.diff <- cbind(result.pure.kdj.k,
                                  result.actual.xreg.kdj.k,
                                  result.predicted.4layers.xreg.kdj.k)



final.result.kdj.kd.diff <- final.result.kdj.kd.diff[, -c(8, 15)]

colnames(final.result.kdj.kd.diff) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                                        "p2","d2","q2", "dr2","RMSE2", "p.v2",
                                        "p3","d3","q3", "dr3","RMSE3", "p.v3")


print(final.result.kdj.kd.diff)

model.name <- c("pure kdj.k Arima",
                   "Arima with actual kdj.kd.diff",
                   "Arima with predicted kdj.kd.diff")

average.rmse <- c(mean(final.result.kdj.kd.diff$RMSE),
                  mean(final.result.kdj.kd.diff$RMSE2),
                  mean(final.result.kdj.kd.diff$RMSE3))

pv.up.0.05 <- c(sum(final.result.kdj.kd.diff$p.v >= 0.05),
                sum(final.result.kdj.kd.diff$p.v2 >= 0.05),
                sum(final.result.kdj.kd.diff$p.v3 >= 0.05))

df.accuracy <- data.frame(model = model.name,
                          average.rmse = average.rmse,
                          pv.up.0.05 = pv.up.0.05)

print(df.accuracy)

mean(final.result.kdj.kd.diff$RMSE > final.result.kdj.kd.diff$RMSE3) 

```

#### 3.4 Comparison of forecast accuracy of monthly KDJ.K by monthly gold price
```{r appendix 3.4-1, echo = FALSE}
# rm(list = ls())
# 
# setwd("d://MyR//stock//")
# monthly.original.data <- read.csv("goldmonthly.csv")
# 
# monthly.close.price <- as.ts(monthly.original.data[,5])
# monthly.kdj.k <- as.ts(monthly.original.data[,7])
# monthly.kdj.d <- as.ts(monthly.original.data[,8])
```

```{r appendix 3.4-2, fig.height=12, fig.width=10, echo = FALSE, cache=FALSE, eval=TRUE}
source("CompareObjectAccuracy.R")
source("CompareObjectXregAccuracy.R")
source("CompareObjectEstimated2layersXregAccuracy.R")


comparison.period <- 20

forecast.period <- 5

training.set.endpoint <- length(monthly.kdj.k) - comparison.period - forecast.period

maxorder <- 5

# result.pure.kdj.k <- CompareObjectAccuracy(arg.object = monthly.kdj.k,
#                                                  arg.forecast.period = forecast.period,
#                                                  arg.training.set.endpoint = training.set.endpoint,
#                                                  arg.comparison.period = comparison.period,
#                                                  arg.maxorder = maxorder)


reg.lagged.df <- 
        data.frame(cbind(monthly.close.price,
                         ts(c(NA, monthly.close.price[-length(monthly.close.price)]))))
```

```{r appendix 3.4-3, fig.height=12, fig.width=10, echo = FALSE, cache=TRUE, eval=TRUE}
result.actual.xreg.kdj.k <-
        CompareObjectXregAccuracy(arg.object = monthly.kdj.k,
                                  arg.forecast.period = forecast.period,
                                  arg.training.set.endpoint = training.set.endpoint,
                                  arg.comparison.period = comparison.period,
                                  arg.maxorder = maxorder,
                                  arg.xreg = reg.lagged.df)

```

```{r appendix 3.4-4, fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.2layers.xreg.kdj.k <-
        CompareObjectEstimated2layersXregAccuracy(arg.object = monthly.kdj.k,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = maxorder,
                                                  arg.reg.variable = monthly.close.price)

```

```{r appendix 3.4-4(2), fig.height=12, fig.width=10, echo = TRUE, cache=TRUE, eval=TRUE}
result.predicted.2layers.xreg.kdj.k.maxorder9 <-
        CompareObjectEstimated2layersXregAccuracy(arg.object = monthly.kdj.k,
                                                  arg.forecast.period = forecast.period,
                                                  arg.training.set.endpoint = training.set.endpoint,
                                                  arg.comparison.period = comparison.period,
                                                  arg.maxorder = 9,
                                                  arg.reg.variable = monthly.close.price)

```

```{r appendix 3.4-4(3), fig.height=12, fig.width=10, echo = TRUE, cache=FALSE, eval=TRUE}
summary(result.predicted.2layers.xreg.kdj.k.maxorder9$RMSE - result.predicted.2layers.xreg.kdj.k$RMSE)

t.test(result.predicted.2layers.xreg.kdj.k.maxorder9$RMSE - result.predicted.2layers.xreg.kdj.k$RMSE)

sum(result.predicted.2layers.xreg.kdj.k.maxorder9$p.v >= 0.05)

sum(result.predicted.2layers.xreg.kdj.k$p.v >= 0.05)

```

For predicting kdj.k using dynamic Arima model with gold price, the difference between the effect of setting max.order to 9 and that of setting max.order to 5 is not significant. 

```{r appendix 3.4-5, fig.height=12, fig.width=10, echo = FALSE, cache=FALSE, eval=TRUE}

final.result.close.price <- cbind(result.pure.kdj.k,
                                  result.actual.xreg.kdj.k,
                                  result.predicted.2layers.xreg.kdj.k)



final.result.close.price <- final.result.close.price[, -c(8, 15)]

colnames(final.result.close.price) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                                        "p2","d2","q2", "dr2","RMSE2", "p.v2",
                                        "p3","d3","q3", "dr3","RMSE3", "p.v3")


print(final.result.close.price)

model.name <- c("pure kdj.k Arima",
                   "Arima with actual close.price",
                   "Arima with predicted close.price")

average.rmse <- c(mean(final.result.close.price$RMSE),
                  mean(final.result.close.price$RMSE2),
                  mean(final.result.close.price$RMSE3))

pv.up.0.05 <- c(sum(final.result.close.price$p.v >= 0.05),
                sum(final.result.close.price$p.v2 >= 0.05),
                sum(final.result.close.price$p.v3 >= 0.05))

df.accuracy <- data.frame(model = model.name,
                          average.rmse = average.rmse,
                          pv.up.0.05 = pv.up.0.05)

print(df.accuracy)

mean(final.result.close.price$RMSE > final.result.close.price$RMSE3) 

```

#### 3.5 Comparison of forecast accuracy of monthly KDJ.K by different factors using predicted value

```{r appendix 3.5, fig.height=5, fig.width=7, echo = FALSE, cache=FALSE, eval=TRUE}

ggplot(,aes(x=factor(c(rep("Pure Arima", length(final.result.kdj.d$RMSE)),
                       rep("KDJ.K", length(final.result.kdj.d$RMSE3)),
                      rep("KDJ.KD.difference", length(final.result.kdj.kd.diff$RMSE3)),
                      rep("gold price", length(final.result.close.price$RMSE3))),
                     levels = c("Pure Arima", 
                                "KDJ.K", 
                                "KDJ.KD.difference", 
                                "gold price")),
           y=c(final.result.kdj.d$RMSE, 
               final.result.kdj.d$RMSE3, 
               final.result.kdj.kd.diff$RMSE3, 
               final.result.close.price$RMSE3))) +
        geom_boxplot() +
        xlab("") +
        ylab("RMSE") +
        ylim(0, 50)

ggplot(,aes(x=factor(c(rep("Pure Arima - KDJ.D", length(final.result.kdj.d$RMSE3)),
                      rep("Pure Arima - KDJ.KD.difference", length(final.result.kdj.kd.diff$RMSE3)),
                      rep("Pure Arima - gold price", length(final.result.close.price$RMSE3))),
                     levels = c("Pure Arima - KDJ.D",
                                "Pure Arima - KDJ.KD.difference",
                                "Pure Arima - gold price")),
           y=c(final.result.kdj.d$RMSE - final.result.kdj.d$RMSE3,
               final.result.kdj.d$RMSE - final.result.kdj.kd.diff$RMSE3,
               final.result.kdj.d$RMSE - final.result.close.price$RMSE3))) +
        geom_boxplot() +
        xlab("") +
        ylab("RMSE difference")+
        ylim(-30, 30)

t.test(final.result.kdj.d$RMSE - final.result.kdj.d$RMSE3)
t.test(final.result.kdj.d$RMSE - final.result.kdj.kd.diff$RMSE3)
t.test(final.result.kdj.d$RMSE - final.result.close.price$RMSE3)


```

It can be concluded that pure Arima model with max.order set to 5 is well for predicting monthly kdj.k.

#### 3.6 Comparison of pure Arima model of monthly kdj.k with naive model

```{r appendix 3.6, fig.height=5, fig.width=7, echo = TRUE, cache=TRUE, eval=TRUE}
setwd("d://MyR//stock//")
source("CompareObjectNaiveAccuracy.R")

result.naive.kdj.k <- CompareObjectNaiveAccuracy(arg.object = monthly.kdj.k,
                                                 arg.forecast.period = forecast.period,
                                                 arg.training.set.endpoint = training.set.endpoint,
                                                 arg.comparison.period = comparison.period,
                                                 arg.maxorder = maxorder)

t.test(result.pure.kdj.k.maxorder9$RMSE - result.naive.kdj.k$RMSE)

t.test(result.pure.kdj.k$RMSE - result.naive.kdj.k$RMSE)

```

```{r appendix 3.6(2), fig.height=5, fig.width=7, echo = TRUE, cache=FALSE, eval=TRUE}

t.test(result.pure.kdj.k$RMSE, result.naive.kdj.k$RMSE)

summary(result.pure.kdj.k$RMSE)

summary(result.naive.kdj.k$RMSE)

# summary(result.arima.naive.close.price$RMSE)

# t.test(result.pure.close.price$RMSE - result.naive.close.price$RMSE)

# final.result.close.price <- cbind(result.pure.close.price.maxorder5,
#                       result.naive.close.price,
#                       result.arima.naive.close.price)

final.result.kdj.k <- cbind(result.pure.kdj.k,
                      result.naive.kdj.k)

# final.result.close.price <- final.result.close.price[, -c(8,15)]

# colnames(final.result.close.price) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
#                             "p2","d2","q2", "dr2","RMSE2", "p.v2",
#                             "p3","d3","q3", "dr3","RMSE3", "p.v3")

final.result.kdj.k <- final.result.kdj.k[, -c(8)]

colnames(final.result.kdj.k) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                            "p2","d2","q2", "dr2","RMSE2", "p.v2")

print(final.result.kdj.k)

sum(final.result.kdj.k$RMSE > final.result.kdj.k$RMSE2)

sum(final.result.kdj.k$p.v > 0.05)
sum(final.result.kdj.k$p.v2 > 0.05)

```

It can be concluded that hybrid model with Arima model and naive model is not needed for predicting monthly kdj.k.


#### 3.7 Comparison of pure Arima model of monthly kdj.k with Zero Difference model

```{r appendix 3.7, fig.height=5, fig.width=7, echo = TRUE, cache=TRUE, eval=TRUE}
setwd("d://MyR//stock//")
source("CompareObjectZeroDiffAccuracy.R")

training.set.endpoint <- length(monthly.kdj.d) - 50 - forecast.period

result.zero.diff.kdj.k.50 <- CompareObjectZeroDiffAccuracy(arg.object = monthly.kdj.k,
                                                 arg.forecast.period = forecast.period,
                                                 arg.training.set.endpoint = training.set.endpoint,
                                                 arg.comparison.period = 50,
                                                 arg.maxorder = maxorder)
```


```{r appendix 3.7(1), fig.height=5, fig.width=7, echo = TRUE, cache=TRUE, eval=TRUE}
result.pure.kdj.k.50 <- CompareObjectAccuracy(arg.object = monthly.kdj.k,
                                                 arg.forecast.period = forecast.period,
                                                 arg.training.set.endpoint = training.set.endpoint,
                                                 arg.comparison.period = 50,
                                                 arg.maxorder = maxorder)


```

```{r appendix 3.7(2), fig.height=5, fig.width=7, echo = TRUE, cache=FALSE, eval=TRUE}

t.test(result.pure.kdj.k.50$RMSE - result.zero.diff.kdj.k.50$RMSE)


summary(result.pure.kdj.k.50$RMSE)

summary(result.zero.diff.kdj.k.50$RMSE)

final.result.kdj.k <- cbind(result.pure.kdj.k.50, result.zero.diff.kdj.k.50)

final.result.kdj.k <- final.result.kdj.k[, -c(8)]

colnames(final.result.kdj.k) <- c("seq", "p","d","q", "dr","RMSE", "p.v",
                            "p2","d2","q2", "dr2","RMSE2", "p.v2")

print(final.result.kdj.k)

sum(final.result.kdj.k$RMSE > final.result.kdj.k$RMSE2)

sum(final.result.kdj.k$p.v >= 0.05)

sum(final.result.kdj.k$p.v2 >= 0.05)

```

It can be concluded that pure Arima model with max.order set to 5 and d set to 0 is well for predicting monthly kdj.k.